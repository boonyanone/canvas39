<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Air Quality Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* IQAir Exact Colors */
            --iqair-blue: #2671ae;
            --white: #ffffff;
            
            /* AQI Colors (IQAir Standard) */
            --aqi-good: #68e143;
            --aqi-moderate: #ffff55;
            --aqi-unhealthy-sensitive: #ef8533;
            --aqi-unhealthy: #ea3324;
            --aqi-very-unhealthy: #8c1a4b;
            --aqi-hazardous: #8c1a4b;
            
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #000000;
            min-height: 100vh;
            color: #ffffff;
            line-height: 1.4;
            margin: 0;
            overflow: hidden;
        }

        /* Dual Layout Container */
        .dual-container {
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            min-height: 100vh;
            width: 100vw;
            background: #000000;
        }

        /* Each Sensor Panel */
        .sensor-panel {
            flex: 1;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sensor-panel:first-child {
            border-right: 2px solid rgba(255,255,255,0.2);
        }

        /* Panel Header */
        .panel-header {
            background: rgba(255,255,255,0.05);
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .sensor-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .sensor-time {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }

        /* Panel Content */
        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            min-height: 0;
        }

        /* AQI Circle for Dual View */
        .aqi-label-small {
            font-size: 18px;
            color: rgba(255,255,255,0.9);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .aqi-circle-container {
            position: relative;
            margin-bottom: 20px;
        }

        .aqi-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #3a3a3a 0%, #2d2d2d 40%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 auto;
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.6),
                0 0 0 4px rgba(255,255,255,0.1),
                inset 0 4px 8px rgba(255,255,255,0.1),
                inset 0 -4px 8px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .aqi-circle::before {
            content: '';
            position: absolute;
            width: 170px;
            height: 170px;
            background: radial-gradient(circle, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .aqi-circle-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .aqi-number-large {
            font-size: 56px;
            font-weight: 400;
            line-height: 1;
            margin-bottom: 6px;
            text-shadow: 
                0 0 20px rgba(255,255,255,0.4),
                0 2px 4px rgba(0,0,0,0.3);
            color: #ffffff;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.2));
        }

        .aqi-circle-label {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        /* AQI Progress Ring */
        .aqi-progress-ring {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(100% - 8px);
            height: calc(100% - 8px);
            transform: rotate(-90deg);
            overflow: visible;
        }

        .aqi-progress-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: butt;
            transition: all 0.8s ease-in-out;
        }

        .aqi-progress-bg {
            stroke: rgba(255,255,255,0.08);
            stroke-width: 6;
        }

        .aqi-progress-fill {
            stroke: #68e143;
            stroke-dasharray: 606;
            stroke-dashoffset: 606;
            filter: drop-shadow(0 0 8px currentColor);
            stroke-width: 8;
        }

        .aqi-status-text {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ffffff;
            text-shadow: 
                0 0 16px rgba(255,255,255,0.5),
                0 2px 4px rgba(0,0,0,0.6);
        }

        .pm25-info {
            font-size: 14px;
            color: #ffffff;
            background: rgba(255,255,255,0.25);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.35);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Additional Info Section */
        .info-section {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: rgba(255,255,255,0.7);
        }

        .info-value {
            color: #ffffff;
            font-weight: 600;
        }

        /* AQI Status Colors for Dual Display */
        .aqi-good .aqi-number-large,
        .aqi-good .aqi-status-text { 
            color: var(--aqi-good); 
            text-shadow: 0 0 20px var(--aqi-good), 0 2px 4px rgba(0,0,0,0.6);
        }
        
        .aqi-good .pm25-info {
            background: rgba(104, 225, 67, 0.2);
            border: 1px solid rgba(104, 225, 67, 0.4);
        }
        
        .aqi-moderate .aqi-number-large,
        .aqi-moderate .aqi-status-text { 
            color: var(--aqi-moderate); 
            text-shadow: 0 0 20px var(--aqi-moderate), 0 2px 4px rgba(0,0,0,0.6);
        }
        
        .aqi-moderate .pm25-info {
            background: rgba(255, 255, 85, 0.2);
            border: 1px solid rgba(255, 255, 85, 0.4);
        }
        
        .aqi-unhealthy-sensitive .aqi-number-large,
        .aqi-unhealthy-sensitive .aqi-status-text { 
            color: var(--aqi-unhealthy-sensitive); 
            text-shadow: 0 0 20px var(--aqi-unhealthy-sensitive), 0 2px 4px rgba(0,0,0,0.6);
        }
        
        .aqi-unhealthy-sensitive .pm25-info {
            background: rgba(239, 133, 51, 0.2);
            border: 1px solid rgba(239, 133, 51, 0.4);
        }
        
        .aqi-unhealthy .aqi-number-large,
        .aqi-unhealthy .aqi-status-text { 
            color: var(--aqi-unhealthy); 
            text-shadow: 0 0 20px var(--aqi-unhealthy), 0 2px 4px rgba(0,0,0,0.6);
        }
        
        .aqi-unhealthy .pm25-info {
            background: rgba(234, 51, 36, 0.2);
            border: 1px solid rgba(234, 51, 36, 0.4);
        }
        
        .aqi-very-unhealthy .aqi-number-large,
        .aqi-very-unhealthy .aqi-status-text { 
            color: var(--aqi-very-unhealthy); 
            text-shadow: 0 0 20px var(--aqi-very-unhealthy), 0 2px 4px rgba(0,0,0,0.6);
        }
        
        .aqi-very-unhealthy .pm25-info {
            background: rgba(140, 26, 75, 0.2);
            border: 1px solid rgba(140, 26, 75, 0.4);
        }
        
        .aqi-hazardous .aqi-number-large,
        .aqi-hazardous .aqi-status-text { 
            color: var(--aqi-hazardous); 
            text-shadow: 0 0 20px var(--aqi-hazardous), 0 2px 4px rgba(0,0,0,0.6);
        }
        
        .aqi-hazardous .pm25-info {
            background: rgba(140, 26, 75, 0.2);
            border: 1px solid rgba(140, 26, 75, 0.4);
        }

        /* Loading State */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #ffffff;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .loading-subtext {
            color: rgba(255,255,255,0.7);
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dual-container {
                flex-direction: column;
            }
            
            .sensor-panel {
                height: 50vh;
            }
            
            .sensor-panel:first-child {
                border-right: none;
                border-bottom: 2px solid rgba(255,255,255,0.2);
            }
            
            .aqi-circle {
                width: 120px;
                height: 120px;
            }
            
            .aqi-circle::before {
                width: 100px;
                height: 100px;
            }
            
            .aqi-number-large {
                font-size: 32px;
            }
            
            .sensor-title {
                font-size: 16px;
            }
            
            .panel-header {
                padding: 8px 16px;
            }
            
            .panel-content {
                padding: 10px;
            }
            
            .info-section {
                padding: 8px 12px;
            }
        }

        /* Global Controls */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.25);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingContainer" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Dual Sensors</div>
        <div class="loading-subtext">Connecting to Air Quality Data</div>
    </div>

    <!-- Global Controls -->
    <div class="controls">
        <button class="control-btn" onclick="refreshAllData()">🔄 Refresh</button>
        <button class="control-btn" onclick="toggleFullscreen()">⛶ Fullscreen</button>
    </div>

    <!-- Dual Sensor Display -->
    <div class="dual-container" id="mainContainer" style="display: none;">
        <!-- Sensor 1 Panel -->
        <div class="sensor-panel" id="sensor1Panel">
            <div class="panel-header">
                <div class="sensor-title" id="sensor1Title">Sensor 1 - Loading...</div>
                <div class="sensor-time" id="sensor1Time">--:--</div>
            </div>
            
            <div class="panel-content" id="sensor1Content">
                <div class="aqi-label-small">US AQI</div>
                
                <!-- AQI Circle for Sensor 1 -->
                <div class="aqi-circle-container">
                    <div class="aqi-circle">
                        <svg class="aqi-progress-ring" viewBox="0 0 192 192" preserveAspectRatio="xMidYMid meet">
                            <circle class="aqi-progress-circle aqi-progress-bg" 
                                    cx="96" cy="96" r="92" />
                            <circle class="aqi-progress-circle aqi-progress-fill" 
                                    id="sensor1ProgressRing"
                                    cx="96" cy="96" r="92" />
                        </svg>
                        
                        <div class="aqi-circle-content">
                            <div class="aqi-number-large" id="sensor1AqiValue">--</div>
                            <div class="aqi-circle-label">AQI</div>
                        </div>
                    </div>
                </div>
                
                <div class="aqi-status-text" id="sensor1Status">Loading...</div>
                <div class="pm25-info" id="sensor1Pm25">PM2.5: -- μg/m³</div>
            </div>
            
            <div class="info-section">
                <div class="info-row">
                    <span class="info-label">Temperature</span>
                    <span class="info-value" id="sensor1Temp">-- °C</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Humidity</span>
                    <span class="info-value" id="sensor1Humidity">-- %</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Source</span>
                    <span class="info-value" id="sensor1Source">--</span>
                </div>
            </div>
        </div>

        <!-- Sensor 2 Panel -->
        <div class="sensor-panel" id="sensor2Panel">
            <div class="panel-header">
                <div class="sensor-title" id="sensor2Title">Sensor 2 - Loading...</div>
                <div class="sensor-time" id="sensor2Time">--:--</div>
            </div>
            
            <div class="panel-content" id="sensor2Content">
                <div class="aqi-label-small">US AQI</div>
                
                <!-- AQI Circle for Sensor 2 -->
                <div class="aqi-circle-container">
                    <div class="aqi-circle">
                        <svg class="aqi-progress-ring" viewBox="0 0 192 192" preserveAspectRatio="xMidYMid meet">
                            <circle class="aqi-progress-circle aqi-progress-bg" 
                                    cx="96" cy="96" r="92" />
                            <circle class="aqi-progress-circle aqi-progress-fill" 
                                    id="sensor2ProgressRing"
                                    cx="96" cy="96" r="92" />
                        </svg>
                        
                        <div class="aqi-circle-content">
                            <div class="aqi-number-large" id="sensor2AqiValue">--</div>
                            <div class="aqi-circle-label">AQI</div>
                        </div>
                    </div>
                </div>
                
                <div class="aqi-status-text" id="sensor2Status">Loading...</div>
                <div class="pm25-info" id="sensor2Pm25">PM2.5: -- μg/m³</div>
            </div>
            
            <div class="info-section">
                <div class="info-row">
                    <span class="info-label">Temperature</span>
                    <span class="info-value" id="sensor2Temp">-- °C</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Humidity</span>
                    <span class="info-value" id="sensor2Humidity">-- %</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Source</span>
                    <span class="info-value" id="sensor2Source">--</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        let CONFIG = {
            API_ENDPOINT: './api/air-quality-multi.php', // Fixed API endpoint
            UPDATE_INTERVAL: 5 * 60 * 1000,
            RETRY_INTERVAL: 30 * 1000,
            MAX_RETRIES: 3,
            SENSORS: []  // Will be loaded from localStorage
        };

        // Load sensors from admin localStorage
        function loadSensorsFromAdmin() {
            try {
                const adminDevices = JSON.parse(localStorage.getItem('air_monitor_devices_v2') || '[]');
                
                if (adminDevices.length > 0) {
                    // Take first 2 devices for dual display
                    CONFIG.SENSORS = adminDevices.slice(0, 2).map((device, index) => ({
                        id: `sensor${index + 1}`,
                        name: device.name || `Device ${index + 1}`,
                        type: device.dataSource || device.sourceConfig?.type || 'device_api',
                        url: device.sourceConfig?.url || device.url,
                        priority: device.priority || (index + 1),
                        deviceId: device.id
                    }));
                    
                    console.log('📡 Loaded sensors from admin:', CONFIG.SENSORS);
                    return true;
                }
            } catch (error) {
                console.error('❌ Error loading sensors from admin:', error);
            }
            
            // Fallback to default configuration
            CONFIG.SENSORS = [
                {
                    id: 'sensor1',
                    name: 'Canvas 39 - Bangkok',
                    type: 'public_station',
                    url: 'https://www.iqair.com/thailand/bangkok/bangkok/canvas-39',
                    priority: 1
                },
                {
                    id: 'sensor2', 
                    name: 'Loading Device...',
                    type: 'device_api',
                    url: 'https://device.iqair.com/v2/6790850e7307e18fb3e0c815/validated-data',
                    priority: 2
                }
            ];
            
            console.log('📡 Using fallback sensors:', CONFIG.SENSORS);
            return false;
        }

        let updateTimer = null;
        let lastUpdateTime = null;

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dual Air Quality Monitor starting');
            initializeApp();
        });

        function initializeApp() {
            console.log('🔧 Initializing dual sensor app...');
            
            // Load sensors from admin first
            loadSensorsFromAdmin();
            
            startDataUpdates();
            setupKeyboardControls();
            startClock();
            
            // Load demo data initially
            setTimeout(() => {
                if (document.getElementById('mainContainer').style.display === 'none') {
                    loadDualDemoData();
                }
            }, 2000);
        }

        // === DATA FETCHING ===
        async function fetchDualSensorData() {
            console.log('📡 Fetching dual sensor data...');

            try {
                // For now, we'll simulate fetching from 2 different sources
                // In the future, you can create a dedicated dual API
                const sensor1Data = await fetchSingleSensor(CONFIG.SENSORS[0]);
                const sensor2Data = await fetchSingleSensor(CONFIG.SENSORS[1]);
                
                return {
                    success: true,
                    sensors: {
                        sensor1: sensor1Data,
                        sensor2: sensor2Data
                    },
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('❌ Dual sensor fetch error:', error);
                throw error;
            }
        }

        async function fetchSingleSensor(sensorConfig) {
            // This is a simplified version - in real implementation, 
            // you would call the actual API for each sensor
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            try {
                const response = await fetch('./api/air-quality-multi.php', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        sources: [sensorConfig]
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success && result.data?.current) {
                    // Use dynamic device name from database or API response
                    let deviceName = sensorConfig.name;
                    
                    // If this is a device API and we have device info, get the real name
                    if (sensorConfig.type === 'device_api' && result.device_info?.name) {
                        deviceName = result.device_info.name;
                    } else if (result.device_name) {
                        deviceName = result.device_name;
                    } else if (sensorConfig.type === 'device_api') {
                        // Extract device ID from URL for better naming
                        const deviceIdMatch = sensorConfig.url.match(/\/([a-f0-9]{24})/);
                        if (deviceIdMatch) {
                            deviceName = `Device ${deviceIdMatch[1].substring(0, 8)}...`;
                        }
                    }
                    
                    return {
                        ...result.data.current,
                        name: deviceName,
                        source_info: {
                            type: result.source,
                            detail: result.data_source_detail
                        }
                    };
                } else {
                    throw new Error('Invalid sensor data format');
                }
                
            } catch (error) {
                console.error(`❌ Error fetching ${sensorConfig.name}:`, error);
                // Return demo data for this sensor
                return getDemoSensorData(sensorConfig);
            }
        }

        function getDemoSensorData(sensorConfig) {
            const baseAqi = sensorConfig.id === 'sensor1' ? 45 : 62;
            const basePm25 = sensorConfig.id === 'sensor1' ? 18 : 25;
            
            return {
                name: sensorConfig.name,
                pollution: {
                    aqius: baseAqi + Math.floor(Math.random() * 10),
                    pm25: { v: basePm25 + Math.floor(Math.random() * 8) },
                    pm10: { v: (basePm25 + Math.floor(Math.random() * 8)) * 1.4 }
                },
                weather: {
                    tp: 28 + Math.floor(Math.random() * 6),
                    hu: 70 + Math.floor(Math.random() * 20),
                    pr: 1010 + Math.floor(Math.random() * 10)
                },
                source_info: {
                    type: sensorConfig.type || 'device_api',
                    detail: 'demo_data'
                }
            };
        }

        // === DATA PROCESSING ===
        function processDualSensorData(dualData) {
            console.log('🔄 Processing dual sensor data');
            
            try {
                updateSensorDisplay('sensor1', dualData.sensors.sensor1);
                updateSensorDisplay('sensor2', dualData.sensors.sensor2);
                
                lastUpdateTime = new Date();
                showMainContent();
                
                console.log('✅ Dual sensor data updated successfully');
                
            } catch (error) {
                console.error('❌ Error processing dual data:', error);
                loadDualDemoData();
            }
        }

        function updateSensorDisplay(sensorId, sensorData) {
            const pollution = sensorData.pollution;
            const weather = sensorData.weather;
            const sourceInfo = sensorData.source_info;
            
            // Update title
            document.getElementById(`${sensorId}Title`).textContent = sensorData.name;
            
            // Update AQI with circular progress
            const aqiValue = pollution.aqius || 0;
            const aqiStatus = updateAQICircle(sensorId, aqiValue);
            
            document.getElementById(`${sensorId}AqiValue`).textContent = aqiValue;
            document.getElementById(`${sensorId}Status`).textContent = aqiStatus.text;
            
            // Update PM2.5
            const pm25Value = pollution.pm25?.v || 0;
            document.getElementById(`${sensorId}Pm25`).textContent = `PM2.5: ${pm25Value} μg/m³`;
            
            // Update weather data
            document.getElementById(`${sensorId}Temp`).textContent = `${weather.tp || '--'} °C`;
            document.getElementById(`${sensorId}Humidity`).textContent = `${weather.hu || '--'} %`;
            
            // Update source
            const sourceText = {
                'station_api': 'STATION',
                'public_station': 'WEB',
                'device_api': 'DEVICE',
                'city_api': 'CITY'
            };
            
            let displaySource = sourceText[sourceInfo?.type] || sourceInfo?.type || '--';
            
            // Add demo indicator if using demo data
            if (sourceInfo?.detail === 'demo_data') {
                displaySource += ' (DEMO)';
            }
            
            document.getElementById(`${sensorId}Source`).textContent = displaySource;
            
            // Update time
            document.getElementById(`${sensorId}Time`).textContent = 
                formatTime(lastUpdateTime);
                
            // Update device status in admin localStorage
            updateDeviceStatusInAdmin(sensorId, sensorData);
        }

        function updateDeviceStatusInAdmin(sensorId, sensorData) {
            try {
                const adminDevices = JSON.parse(localStorage.getItem('air_monitor_devices_v2') || '[]');
                const sensorConfig = CONFIG.SENSORS.find(s => s.id === sensorId);
                
                if (sensorConfig && sensorConfig.deviceId) {
                    const deviceIndex = adminDevices.findIndex(d => d.id === sensorConfig.deviceId);
                    
                    if (deviceIndex !== -1) {
                        adminDevices[deviceIndex].status = 'online';
                        adminDevices[deviceIndex].lastUpdate = new Date().toISOString();
                        adminDevices[deviceIndex].data = {
                            aqi: sensorData.pollution?.aqius || 0,
                            pm25: sensorData.pollution?.pm25?.v || 0,
                            temp: sensorData.weather?.tp || 0,
                            humidity: sensorData.weather?.hu || 0
                        };
                        
                        localStorage.setItem('air_monitor_devices_v2', JSON.stringify(adminDevices));
                        console.log(`✅ Updated admin status for ${sensorData.name}`);
                    }
                }
            } catch (error) {
                console.error('❌ Error updating admin device status:', error);
            }
        }

        function getAQIStatus(aqi) {
            if (aqi <= 50) return { 
                text: 'Good', 
                class: 'aqi-good',
                color: '#68e143'
            };
            if (aqi <= 100) return { 
                text: 'Moderate', 
                class: 'aqi-moderate',
                color: '#ffff55'
            };
            if (aqi <= 150) return { 
                text: 'Unhealthy for Sensitive', 
                class: 'aqi-unhealthy-sensitive',
                color: '#ef8533'
            };
            if (aqi <= 200) return { 
                text: 'Unhealthy', 
                class: 'aqi-unhealthy',
                color: '#ea3324'
            };
            if (aqi <= 300) return { 
                text: 'Very Unhealthy', 
                class: 'aqi-very-unhealthy',
                color: '#8c1a4b'
            };
            return { 
                text: 'Hazardous', 
                class: 'aqi-hazardous',
                color: '#722f37'
            };
        }

        function updateAQICircle(sensorId, aqi) {
            const status = getAQIStatus(aqi);
            const progressRing = document.getElementById(`${sensorId}ProgressRing`);
            const sensorContent = document.getElementById(`${sensorId}Content`);
            
            if (progressRing) {
                const radius = 92;
                const circumference = 2 * Math.PI * radius;
                
                let percentage = Math.min((aqi / 300) * 100, 100);
                const offset = circumference - (percentage / 100) * circumference;
                
                progressRing.style.strokeDasharray = circumference.toFixed(2);
                progressRing.style.strokeDashoffset = offset.toFixed(2);
                progressRing.style.stroke = status.color;
            }
            
            // Apply color class to content
            if (sensorContent) {
                sensorContent.className = `panel-content ${status.class}`;
            }
            
            return status;
        }

        // === UPDATE SYSTEM ===
        function startDataUpdates() {
            console.log('🔄 Starting dual sensor data updates');
            
            // Initial update
            updateDualSensorData();
            
            // Set up recurring updates
            if (updateTimer) clearInterval(updateTimer);
            updateTimer = setInterval(updateDualSensorData, CONFIG.UPDATE_INTERVAL);
            
            console.log(`⏰ Auto-update every ${CONFIG.UPDATE_INTERVAL / 60000} minutes`);
        }

        async function updateDualSensorData() {
            try {
                const dualData = await fetchDualSensorData();
                processDualSensorData(dualData);
            } catch (error) {
                console.error('❌ Dual update failed:', error);
                loadDualDemoData();
            }
        }

        // === DEMO DATA ===
        function loadDualDemoData() {
            console.log('🎭 Loading dual demo data');
            
            const dualDemoData = {
                success: true,
                sensors: {
                    sensor1: getDemoSensorData(CONFIG.SENSORS[0]),
                    sensor2: getDemoSensorData(CONFIG.SENSORS[1])
                }
            };
            
            processDualSensorData(dualDemoData);
        }

        // === UI FUNCTIONS ===
        function showMainContent() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
        }

        function refreshAllData() {
            console.log('🔄 Manual refresh triggered');
            updateDualSensorData();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function formatTime(date) {
            if (!date) return '--:--';
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Asia/Bangkok',
                hour12: false
            });
        }

        function startClock() {
            function updateClocks() {
                const now = new Date();
                const timeString = formatTime(now);
                
                // Update both sensor times if they're showing current time
                if (document.getElementById('sensor1Time').textContent.includes(':')) {
                    document.getElementById('sensor1Time').textContent = timeString;
                }
                if (document.getElementById('sensor2Time').textContent.includes(':')) {
                    document.getElementById('sensor2Time').textContent = timeString;
                }
            }
            
            updateClocks();
            setInterval(updateClocks, 1000);
        }

        // === KEYBOARD CONTROLS ===
        function setupKeyboardControls() {
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        refreshAllData();
                        break;
                    case 'f':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            toggleFullscreen();
                        }
                        break;
                    case 'r':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            location.reload();
                        }
                        break;
                }
            });
        }

        // === GLOBAL DEBUG COMMANDS ===
        window.dualAirQuality = {
            refresh: refreshAllData,
            demo: loadDualDemoData,
            fullscreen: toggleFullscreen,
            config: CONFIG
        };

        console.log('🚀 Dual Air Quality Display initialized');
        console.log('💻 Console commands: dualAirQuality.refresh(), .demo(), .fullscreen()');
    </script>
</body>
</html>